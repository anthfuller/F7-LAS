name: F7-LAS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. (Optional) Linting – only runs if flake8 is installed
      - name: Run flake8 (lint)
        run: |
          if python -m pip show flake8 > /dev/null 2>&1; then
            flake8 src tests scripts
          else
            echo "flake8 not installed, skipping lint step."
          fi

      # 5. Unit tests – basic correctness for agents/core/tools
      - name: Run unit tests
        run: |
          pytest -q tests/test-agents-basic.py

      # 6. Golden dataset evaluation – end-to-end behavior check
      - name: Run golden dataset evaluation
        run: |
          python -m src.demo_runner.run_golden_dataset \
            --scenarios tests/golden-dataset/scenarios.json \
            --rubric tests/golden-dataset/rubric.json \
            --output golden_eval_results.json

      # 7. Enforce golden scenario thresholds (Layer 7 guardrail)
      - name: Check golden thresholds
        run: |
          python scripts/check-golden-thresholds.py golden_eval_results.json

      # 8. Validate prompts (Layer 1)
      - name: Validate prompts
        run: |
          python scripts/validate-prompts.py

      # 9. Validate policies (Layer 5)
      - name: Validate policies
        run: |
          python scripts/validate-policies.py

      # 10. Validate settings (Layer 3 safety bounds)
      - name: Validate settings
        run: |
          python scripts/validate-settings.py

      # 11. (Optional) Placeholder for SBOM / dependency scan
      - name: SBOM / dependency scan (placeholder)
        run: |
          echo "SBOM/SCA step not yet configured. Add your tool of choice here."
